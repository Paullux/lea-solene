server {
    listen 80;
    server_name lea-solene.fr;

    root /var/www/html;
    index index.php index.html;

    # IP r√©elle derri√®re le proxy Coolify
    real_ip_header X-Forwarded-For;
    set_real_ip_from 0.0.0.0/0;

    # Redirection physique du .php vers l'URL sans extension
    if ($request_uri ~ ^/([^?]+)\.php($|\?)) {
        return 301 /$1$is_args$args;
    }

    location / {
        # On tente le fichier exact, puis le dossier
        try_files $uri $uri/ @extensionless-php;
    }

    # Bloc sp√©cial pour traiter le fichier .php s'il existe
    location @extensionless-php {
        rewrite ^(.*)$ $1.php last;
    }

    location ~ \.php$ {
        try_files $uri =404; # S√©curit√© : √©vite l'index si le fichier est manquant
        include fastcgi_params;
        fastcgi_pass php:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

        # üîë HTTPS derri√®re Coolify
        fastcgi_param HTTP_X_FORWARDED_PROTO https;
        fastcgi_param HTTPS on;
    }
    
    location /assets/audio/ {
        # 1. Force le type MIME
        types {
            audio/mpeg  mp3;
            audio/x-wav wav;
        }
        default_type audio/mpeg;

        # 2. Support des Range Requests (Crucial pour le Seek)
        add_header Accept-Ranges bytes;

        # 3. S√©curit√© pour le streaming
        gzip off;

        # 4. Cache navigateur
        expires 7d;
        add_header Cache-Control "public, no-transform";

        # 5. Optimisations Docker/Linux
        sendfile on;
        tcp_nopush on;
        
        # 6. √âviter le buffering pour l'audio
        proxy_buffering off; 
    }
}