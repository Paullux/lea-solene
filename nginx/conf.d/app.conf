server {
    listen 80;
    server_name lea-solene.fr;

    root /var/www/html;
    index index.php index.html;

    # IP r√©elle derri√®re le proxy Coolify
    real_ip_header X-Forwarded-For;
    set_real_ip_from 0.0.0.0/0;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass php:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

        # üîë cl√© absolue pour HTTPS derri√®re Coolify
        fastcgi_param HTTP_X_FORWARDED_PROTO https;
        fastcgi_param HTTPS on;
    }
    
    location /assets/audio/ {
        # 1. Force le type MIME pour que Chrome traite le fichier comme un stream
        types {
            audio/mpeg  mp3;
            audio/x-wav wav;
        }
        default_type audio/mpeg;

        # 2. Support des Range Requests (Crucial pour le Seek)
        add_header Accept-Ranges bytes;

        # 3. S√©curit√© pour le streaming
        # On d√©sactive gzip car compresser un MP3 (d√©j√† compress√©) ne sert √† rien 
        # et cela emp√™che Nginx de calculer la taille exacte pour le Seek.
        gzip off;

        # 4. Cache navigateur
        expires 7d;
        add_header Cache-Control "public, no-transform";

        # 5. Optimisations Docker/Linux
        sendfile on;       # En production (Linux), sendfile est tr√®s performant
        tcp_nopush on;     # Envoie les headers et le d√©but du fichier en un seul paquet
        
        # 6. √âviter le buffering pour l'audio (optionnel mais recommand√©)
        proxy_buffering off; 
    }
}
