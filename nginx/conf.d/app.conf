server {
    listen 80;
    server_name lea-solene.fr;

    root /var/www/html;
    index index.php index.html;

    # IP réelle derrière le proxy Coolify
    real_ip_header X-Forwarded-For;
    set_real_ip_from 0.0.0.0/0;

    # --- 1. PRIORITÉ ABSOLUE POUR LA NEWSLETTER ---
    # On place ce bloc en haut pour éviter les redirections .php
    location = /subscribe {
        include fastcgi_params;
        fastcgi_pass php:9000;
        fastcgi_param SCRIPT_FILENAME $document_root/subscribe.php;
        
        # Forçage du HTTPS pour éviter le Mixed Content côté serveur
        fastcgi_param HTTPS on;
        fastcgi_param HTTP_X_FORWARDED_PROTO https;
    }

    # --- 2. GESTION DES URLS SANS EXTENSION ---
    # Redirection physique du .php vers l'URL sans extension
    # On exclut /subscribe pour ne pas créer de boucle
    if ($request_uri ~ ^/(?!subscribe)([^?]+)\.php($|\?)) {
        return 301 https://$host/$1$is_args$args;
    }

    location / {
        # On tente le fichier exact, puis le dossier, sinon on cherche le .php
        try_files $uri $uri/ @extensionless-php;
    }

    # Traitement générique des fichiers sans extension
    location @extensionless-php {
        rewrite ^(.*)$ $1.php last;
    }

    # --- 3. TRAITEMENT PHP GÉNÉRIQUE ---
    location ~ \.php$ {
        try_files $uri =404;
        include fastcgi_params;
        fastcgi_pass php:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

        # Sécurité HTTPS derrière Coolify
        fastcgi_param HTTP_X_FORWARDED_PROTO https;
        fastcgi_param HTTPS on;
    }
    
    # --- 4. OPTIMISATION AUDIO ---
    location /assets/audio/ {
        types {
            audio/mpeg  mp3;
            audio/x-wav wav;
        }
        default_type audio/mpeg;

        add_header Accept-Ranges bytes;
        gzip off;
        expires 7d;
        add_header Cache-Control "public, no-transform";

        sendfile on;
        tcp_nopush on;
        proxy_buffering off; 
    }
}