server {
    listen 80;
    server_name lea-solene.fr;

    root /var/www/html;
    index index.php index.html;

    # IP rÃ©elle derriÃ¨re le proxy Coolify
    real_ip_header X-Forwarded-For;
    set_real_ip_from 0.0.0.0/0;

    # 1. Redirige .php vers l'URL propre (seulement si ce n'est pas une requÃªte interne)
    if ($request_uri ~ ^/([^?]+)\.php($|\?)) {
        return 301 /$1$is_args$args;
    }

    location / {
        # 2. On essaie d'abord le fichier exact, puis le .php, et SEULEMENT Ã  la fin l'index
        # L'ordre doit Ãªtre : fichier -> dossier -> fichier.php -> index.php
        try_files $uri $uri/ $uri.php?$query_string /index.php?$query_string;
    }

    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass php:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

        # ðŸ”‘ clÃ© absolue pour HTTPS derriÃ¨re Coolify
        fastcgi_param HTTP_X_FORWARDED_PROTO https;
        fastcgi_param HTTPS on;
    }
    
    location /assets/audio/ {
        # 1. Force le type MIME
        types {
            audio/mpeg  mp3;
            audio/x-wav wav;
        }
        default_type audio/mpeg;

        # 2. Support des Range Requests (Crucial pour le Seek)
        add_header Accept-Ranges bytes;

        # 3. SÃ©curitÃ© pour le streaming
        gzip off;

        # 4. Cache navigateur
        expires 7d;
        add_header Cache-Control "public, no-transform";

        # 5. Optimisations Docker/Linux
        sendfile on;
        tcp_nopush on;
        
        # 6. Ã‰viter le buffering pour l'audio
        proxy_buffering off; 
    }
}